<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Lobby – Diplomacy</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 2em;
      background: #f7f7f7;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    button {
      background: #0066cc;
      color: white;
      border: none;
      padding: 0.5em 1em;
      border-radius: 0.3em;
      cursor: pointer;
    }
    button:hover { background: #004999; }
    .game {
      background: white;
      border-radius: 0.5em;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin: 1em 0;
      padding: 1em;
    }
    form#createForm {
      margin-top: 1em;
      background: white;
      padding: 1em;
      border-radius: 0.5em;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    input {
      padding: 0.5em;
      margin-right: 0.5em;
      border-radius: 0.3em;
      border: 1px solid #ccc;
    }
    .msg {
      color: red;
      margin-top: 0.5em;
    }
    dialog {
      border: none;
      border-radius: 0.5em;
      padding: 1em;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>
  <header>
    <h1>Game Lobby</h1>
    <button onclick="logout()">Logout</button>
  </header>

  <section>
    <h2>Create New Game</h2>
    <form id="createForm">
      <input type="text" id="gameName" placeholder="Game name" required>
      <button type="submit">Create</button>
    </form>
    <p class="msg" id="createMsg"></p>
  </section>

  <section>
    <h2>Available Games</h2>
    <div id="games"></div>
  </section>

  <!-- Join modal -->
  <dialog id="joinDialog">
    <h3>Join Game</h3>
    <p>Select your nation:</p>
    <select id="nationSelect"></select>
    <div style="margin-top:1em;">
      <button onclick="confirmJoin()">Join</button>
      <button onclick="document.getElementById('joinDialog').close()">Cancel</button>
    </div>
  </dialog>

<script>
const NATION_NAMES = ["England","France","Germany","Italy","Austria","Russia","Turkey"];
let currentJoinGameId = null;

async function loadGames() {
  const res = await fetch("/api/games");
  const data = await res.json();
  const container = document.getElementById("games");
  if (!data.ok) {
    container.innerHTML = "<p>Login required. <a href='/login'>Go to login</a></p>";
    return;
  }

  if (data.data.length === 0) {
    container.innerHTML = "<p>No games yet. Create one!</p>";
    return;
  }

  container.innerHTML = data.data.map(g => `
    <div class="game">
      <strong>${g.name}</strong><br>
      Status: ${g.status || "waiting"}<br>
      Created: ${g.started_at || "—"}<br>
      <button onclick="openJoin(${g.id})">Join</button>
    </div>
  `).join('');
}

async function openJoin(id) {
  currentJoinGameId = id;
  const res = await fetch(`/api/games/${id}`);
  const data = await res.json();
  if (!data.ok) {
    alert("Error loading game info");
    return;
  }
  const taken = data.nations.map(n => n.name);
  const available = NATION_NAMES.filter(n => !taken.includes(n));
  const select = document.getElementById("nationSelect");
  select.innerHTML = available.map(n => `<option value="${n}">${n}</option>`).join('');
  if (available.length === 0) {
    alert("All nations already taken!");
    return;
  }
  document.getElementById("joinDialog").showModal();
}

async function confirmJoin() {
  const nation = document.getElementById("nationSelect").value;
  const res = await fetch(`/api/games/${currentJoinGameId}/nations`, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ name: nation })
  });
  const data = await res.json();
  if (data.ok) {
    alert("Joined as " + nation + "!");
    document.getElementById("joinDialog").close();
    loadGames();
  } else {
    alert(data.error || "Could not join game");
  }
}

document.getElementById("createForm").onsubmit = async (e) => {
  e.preventDefault();
  const msg = document.getElementById("createMsg");
  msg.textContent = "";
  const res = await fetch("/api/games", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ name: gameName.value })
  });
  const data = await res.json();
  if (data.ok) {
    msg.style.color = "green";
    msg.textContent = "Game created!";
    gameName.value = "";
    loadGames();
  } else {
    msg.style.color = "red";
    msg.textContent = data.error || "Failed to create game";
  }
};

async function logout() {
  await fetch("/api/logout", { method: "POST" });
  location.href = "/login";
}

loadGames();
</script>
</body>
</html>
