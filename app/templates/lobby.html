<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Diplomacy Lobby</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 20px;
    }
    h1 {
      color: #333;
    }
    .games {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }
    .card {
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      padding: 15px;
    }
    .card h3 {
      margin-top: 0;
    }
    .card button {
      background: #007bff;
      border: none;
      color: white;
      padding: 8px 12px;
      border-radius: 5px;
      cursor: pointer;
    }
    .card button:hover {
      background: #0056b3;
    }
    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    button#createGameBtn {
      background: #28a745;
      border: none;
      color: white;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
    }
    button#createGameBtn:hover {
      background: #218838;
    }
    .nations {
      margin-top: 10px;
      font-size: 0.9em;
    }
    .nation {
      display: inline-block;
      margin: 2px 4px;
      padding: 2px 6px;
      border-radius: 5px;
      background: #e9ecef;
    }
    .nation.taken {
      background: #ffcccc;
    }
    .nation.free {
      background: #c8e6c9;
    }
    select {
      padding: 5px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <div class="topbar">
    <h1>Game Lobby</h1>
    <button id="createGameBtn">Create New Game</button>
  </div>

  <div id="gamesList" class="games"></div>

  <script>
    async function loadGames() {
      const res = await fetch("/api/games");
      const data = await res.json();
      if (!data.ok) {
        alert("Failed to load games.");
        return;
      }

      if (!data.data.length) {
        document.getElementById("gamesList").innerHTML =
          "<p>No games available yet. Create one to get started!</p>";
        return;
      }

      document.getElementById("gamesList").innerHTML = data.data.map(g => `
        <div class="card">
          <h3>${g.name}</h3>
          <p>Status: ${g.status}</p>
          <p>Started at: ${new Date(g.started_at).toLocaleString()}</p>
          <button onclick="joinGame(${g.id})">Join</button>
          <div id="nations-${g.id}" class="nations"></div>
        </div>
      `).join('');

      // Load nations for each game
      for (const g of data.data) {
        loadNations(g.id);
      }
    }

    async function loadNations(gameId) {
      const res = await fetch(`/api/games/${gameId}`);
      const data = await res.json();
      if (!data.ok) return;

      const nationsDiv = document.getElementById(`nations-${gameId}`);
      if (!nationsDiv) return;

      nationsDiv.innerHTML = data.nations.map(n => `
        <span class="nation ${n.user_id ? 'taken' : 'free'}">
          ${n.name} ${n.user_id ? '(taken)' : '(free)'}
        </span>
      `).join('');
    }

    async function createGame() {
      const name = prompt("Enter a name for the new game:");
      if (!name) return;

      const res = await fetch("/api/games", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ name })
      });
      const data = await res.json();

      if (data.ok) {
        alert("Game created successfully!");
        // Immediately join a nation
        await joinGame(data.id);
      } else {
        alert(data.error || "Failed to create game.");
      }
    }

    async function joinGame(gameId) {
      // Fetch game + user info
      const [gameRes, meRes] = await Promise.all([
        fetch(`/api/games/${gameId}`),
        fetch(`/api/me`)
      ]);
      const gameData = await gameRes.json();
      const meData = await meRes.json();

      if (!gameData.ok || !meData.ok) {
        alert("Failed to load game or user info.");
        return;
      }

      // Already joined?
      if (gameData.nations.some(n => String(n.user_id) === String(meData.user.id))) {
        window.location.href = `/game/${gameId}`;
        return;
      }

      // Filter free nations
      const available = gameData.nations.filter(n => !n.user_id);
      if (!available.length) {
        alert("No nations left to join in this game!");
        return;
      }

      // Build select dropdown for available nations
      const selectHtml = available.map(n => `<option value="${n.name}">${n.name}</option>`).join('');
      const container = document.createElement('div');
      container.id = 'joinContainer';
      container.style.marginTop = "10px";
      container.innerHTML = `
        <label>Select your nation: </label>
        <select id="nationSelect">${selectHtml}</select>
        <button id="confirmJoin">Join Game</button>
      `;
      document.body.appendChild(container);

      document.getElementById("confirmJoin").addEventListener("click", async () => {
        const nationName = document.getElementById("nationSelect").value;
        const res = await fetch(`/api/games/${gameId}/nations`, {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({ name: nationName })
        });
        const data = await res.json();

        if (data.ok) {
          alert(`You joined as ${nationName}!`);
          window.location.href = `/game/${gameId}`;
        } else {
          alert(data.error || "Failed to join game.");
        }
      });
    }

    document.getElementById("createGameBtn").addEventListener("click", createGame);
    loadGames();
  </script>
</body>
</html>
